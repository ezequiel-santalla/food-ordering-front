<div class="min-h-screen bg-base-200 pb-24">
  <!-- Header con tabs -->
  <div class="bg-base-100 border-b border-base-300 sticky top-0 z-10">
    <div class="max-w-md mx-auto px-4 py-4">
      <h1 class="text-2xl font-bold text-base-content mb-4">
        <lucide-icon [img]="CreditCard" class="inline-block mr-2" [size]="28"></lucide-icon>
        Pagos
      </h1>
      
      <!-- Tabs -->
      <div class="tabs tabs-boxed bg-base-200">
        <button 
          class="tab"
          [class.tab-active]="activeTab() === 'pay'"
          (click)="switchTab('pay')"
        >
          <lucide-icon [img]="DollarSign" [size]="16" class="mr-1"></lucide-icon>
          Pagar
        </button>
        <button 
          class="tab"
          [class.tab-active]="activeTab() === 'history'"
          (click)="switchTab('history')"
        >
          <lucide-icon [img]="Receipt" [size]="16" class="mr-1"></lucide-icon>
          Historial
        </button>
      </div>
    </div>
  </div>

  <!-- Contenido según tab activo -->
  <div class="max-w-md mx-auto px-4 py-6">
    
    <!-- TAB: PAGAR -->
    @if (activeTab() === 'pay') {
      <div class="space-y-6">
        
        <!-- Acciones rápidas -->
        @if (unpaidOrders().length > 0) {
          <div class="flex gap-2">
            <button 
              class="btn btn-sm btn-outline flex-1"
              (click)="selectAllOrders()"
              [disabled]="isProcessingPayment()"
            >
              Seleccionar todas
            </button>
            @if (hasSelectedOrders()) {
              <button 
                class="btn btn-sm btn-ghost"
                (click)="clearSelection()"
              >
                Limpiar
              </button>
            }
          </div>
        }

        <!-- Lista de órdenes sin pagar -->
        @if (isLoadingOrders()) {
          <div class="flex justify-center py-12">
            <span class="loading loading-spinner loading-lg"></span>
          </div>
        } @else if (unpaidOrders().length === 0) {
          <div class="card bg-base-100 shadow-sm">
            <div class="card-body text-center py-12">
              <lucide-icon [img]="CheckCircle" [size]="64" class="mx-auto text-success mb-4"></lucide-icon>
              <h3 class="text-lg font-semibold text-base-content">¡Todo pago!</h3>
              <p class="text-sm text-base-content/70">No tienes órdenes pendientes de pago</p>
            </div>
          </div>
        } @else {
          <div class="space-y-3">
            @for (order of unpaidOrders(); track order.publicId) {
              <app-order-card
                [order]="order"
                (selected)="onOrderSelected($event)"
              ></app-order-card>
            }
          </div>
        }

        <!-- Footer de pago (solo si hay órdenes) -->
        @if (unpaidOrders().length > 0) {
          <div class="card bg-base-100 shadow-lg sticky bottom-20">
            <div class="card-body p-4">
              @if (hasSelectedOrders()) {
                <!-- Selector de método de pago -->
                <div class="mb-4">
                  <label class="text-sm font-semibold text-base-content/70 mb-2 block">
                    Método de pago:
                  </label>
                  <div class="grid grid-cols-2 gap-2">
                    @for (method of paymentMethods; track method.value) {
                      <button
                        class="btn btn-sm"
                        [class.btn-primary]="selectedPaymentMethod() === method.value"
                        [class.btn-outline]="selectedPaymentMethod() !== method.value"
                        (click)="onPaymentMethodChange(method.value)"
                        [disabled]="isProcessingPayment()"
                      >
                        <lucide-icon [img]="method.icon" [size]="16"></lucide-icon>
                        {{ method.label }}
                      </button>
                    }
                  </div>
                </div>

                <!-- Resumen -->
                <div class="divider my-2"></div>
                <div class="flex justify-between items-center mb-3">
                  <div>
                    <p class="text-sm text-base-content/70">
                      {{ selectedOrderIds().size }} orden(es)
                    </p>
                    <p class="text-3xl font-bold text-primary">
                      ${{ totalToPay() | number:'1.2-2' }}
                    </p>
                  </div>
                </div>
                
                <!-- Botón de pago -->
                <button 
                  class="btn btn-primary btn-lg w-full"
                  [class.btn-disabled]="isProcessingPayment()"
                  [disabled]="isProcessingPayment()"
                  (click)="processPayment()"
                >
                  @if (isProcessingPayment()) {
                    <span class="loading loading-spinner"></span>
                    Procesando...
                  } @else {
                    <lucide-icon [img]="CreditCard" [size]="24"></lucide-icon>
                    Confirmar Pago
                  }
                </button>

                @if (paymentError()) {
                  <div class="alert alert-error mt-2">
                    <lucide-icon [img]="XCircle" [size]="20"></lucide-icon>
                    <span class="text-sm">{{ paymentError() }}</span>
                  </div>
                }
              } @else {
                <!-- Sin órdenes seleccionadas -->
                <div class="text-center py-4">
                  <lucide-icon [img]="Receipt" [size]="48" class="mx-auto text-base-content/30 mb-2"></lucide-icon>
                  <p class="text-sm text-base-content/70">
                    Selecciona las órdenes que deseas pagar
                  </p>
                </div>
              }
            </div>
          </div>
        }
      </div>
    }

    <!-- TAB: HISTORIAL -->
    @if (activeTab() === 'history') {
      <div class="space-y-4">
        @if (isLoadingPayments()) {
          <div class="flex justify-center py-12">
            <span class="loading loading-spinner loading-lg"></span>
          </div>
        } @else if (paymentsHistory().length === 0) {
          <div class="card bg-base-100 shadow-sm">
            <div class="card-body text-center py-12">
              <lucide-icon [img]="Receipt" [size]="64" class="mx-auto text-base-content/30 mb-4"></lucide-icon>
              <h3 class="text-lg font-semibold text-base-content">Sin historial</h3>
              <p class="text-sm text-base-content/70">Aún no has realizado ningún pago</p>
            </div>
          </div>
        } @else {
          @for (payment of paymentsHistory(); track payment.publicId) {
            <div class="card bg-base-100 shadow-sm hover:shadow-md transition-shadow">
              <div class="card-body p-4">
                <div class="flex justify-between items-start">
                  <div class="flex-1">
                    <div class="flex items-center gap-2 mb-2">
                      <lucide-icon 
                        [img]="getPaymentMethodIcon(payment.paymentMethod)" 
                        [size]="20"
                        class="text-primary"
                      ></lucide-icon>
                      <span class="font-semibold text-base-content">
                        {{ getPaymentMethodLabel(payment.paymentMethod) }}
                      </span>
                      <span class="badge badge-success badge-sm">
                        {{ payment.status }}
                      </span>
                    </div>
                    
                    <div class="flex items-center gap-2 text-xs text-base-content/70 mb-2">
                      <lucide-icon [img]="Calendar" [size]="14"></lucide-icon>
                      <span>{{ formatDate(payment.createdAt) }}</span>
                    </div>

                    <p class="text-xs text-base-content/60">
                      {{ payment.orderIds.length }} orden(es) pagada(s)
                    </p>
                  </div>

                  <div class="text-right">
                    <p class="text-2xl font-bold text-success">
                      ${{ payment.amount | number:'1.2-2' }}
                    </p>
                    <p class="text-xs text-base-content/60">
                      #{{ payment.publicId.slice(0, 8) }}
                    </p>
                  </div>
                </div>
              </div>
            </div>
          }
        }
      </div>
    }
  </div>
</div>