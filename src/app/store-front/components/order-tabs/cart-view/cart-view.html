<section class="bg-white rounded-2xl shadow-lg p-6 space-y-4">
  <h3 class="text-xl font-semibold text-gray-800 mb-2 flex items-center gap-2">
    <lucide-icon [img]="ShoppingBasket"></lucide-icon>
    <span>Tu Orden</span>
  </h3>

  @if (cartService.items().length === 0) {
  <div class="flex flex-col items-center justify-center text-center py-8">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="48"
      height="48"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="1.5"
      stroke-linecap="round"
      stroke-linejoin="round"
      class="text-gray-300 mb-3"
    >
      <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <path d="M16 10a4 4 0 0 1-8 0"></path>
    </svg>
    <p class="text-gray-500 font-medium">Tu orden está vacía.</p>
    <p class="text-sm text-gray-400">Agrega productos para continuar.</p>
  </div>

  } @else {

  <div class="divide-y divide-gray-100 max-h-[300px] overflow-y-auto pr-2">
    @for (item of cartService.items(); track $index) {

    <div class="py-4">
      <div class="flex gap-3">
        <img
          [src]="item.productImage"
          class="w-16 h-16 object-cover rounded-xl border flex-shrink-0"
        />

        <div class="flex-1 flex flex-col gap-1.5">
          <div class="flex justify-between items-start gap-2">
            <p class="font-medium text-gray-800 flex-1">
              {{ item.productName }}
            </p>

            <button
              class="w-7 h-7 flex items-center justify-center rounded-full hover:bg-red-50 active:bg-red-100 transition text-error flex-shrink-0"
              (click)="removeItem($index, item.productName)"
            >
              <lucide-icon [img]="Trash2" [size]="18"></lucide-icon>
            </button>
          </div>

          <div class="flex justify-between items-center">
            <span class="font-semibold text-gray-800">
              {{ (item.productPrice * item.quantity) | currency:'ARS' }}
            </span>

            <div class="flex items-center gap-1">
              <button
                class="w-7 h-7 flex items-center justify-center rounded-full hover:bg-gray-100 active:bg-gray-200 transition disabled:opacity-30 disabled:hover:bg-transparent"
                (click)="cartService.updateQuantity($index, item.quantity - 1)"
                [disabled]="item.quantity === 1"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="18"
                  height="18"
                  stroke="currentColor"
                  stroke-width="2"
                  fill="none"
                  stroke-linecap="round"
                >
                  <line x1="4" y1="9" x2="14" y2="9"></line>
                </svg>
              </button>

              <span
                class="min-w-[24px] text-center font-bold text-gray-800 text-base px-1"
              >
                {{ item.quantity }}
              </span>

              <button
                class="w-7 h-7 flex items-center justify-center rounded-full hover:bg-gray-100 active:bg-gray-200 transition"
                (click)="cartService.updateQuantity($index, item.quantity + 1)"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="18"
                  height="18"
                  stroke="currentColor"
                  stroke-width="2"
                  fill="none"
                  stroke-linecap="round"
                >
                  <line x1="9" y1="4" x2="9" y2="14"></line>
                  <line x1="4" y1="9" x2="14" y2="9"></line>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-1 ml-[76px]">
        <button
          type="button"
          (click)="toggleItemExpand(item)"
          class="text-xs italic text-gray-600 flex items-center gap-1 w-fit"
        >
          <lucide-icon [img]="Pencil" [size]="13"></lucide-icon>
          <span class="truncate max-w-[250px]">
            {{ item.specialInstructions || 'Agregar instrucciones…' }}
          </span>
        </button>

        @if (item._expand) {
        <textarea
          [(ngModel)]="item.specialInstructions"
          rows="2"
          class="mt-2 w-full border border-gray-300 rounded-lg p-2 text-xs text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-400 resize-none"
          placeholder="Escribí instrucciones especiales…"
        ></textarea>
        }
      </div>
    </div>

    }
  </div>

  <div class="mt-4 mb-24">
    <button
      type="button"
      (click)="toggleSpecial()"
      class="w-full flex justify-between items-center px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-gray-800 text-sm font-medium hover:bg-gray-100 transition"
    >
      <span>Requisitos especiales (opcional)</span>

      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="w-5 h-5 transition-transform"
        [class.rotate-180]="expandSpecial()"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M19 9l-7 7-7-7"
        />
      </svg>
    </button>

    @if (expandSpecial()) {
    <div class="mt-3">
      <textarea
        [(ngModel)]="generalInstructions"
        rows="3"
        placeholder="Alergías, intolerancias, cubiertos, etc..."
        class="w-full border border-gray-300 rounded-lg p-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-400"
        [disabled]="isSubmitting()"
      ></textarea>
    </div>
    }
  </div>

  @if (error()) {
  <div class="alert alert-error my-2">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="stroke-current shrink-0 h-6 w-6"
      fill="none"
      viewBox="0 0 24 24"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"
      />
    </svg>
    <span>{{ error() }}</span>
  </div>
  }

  <footer class="border-t border-gray-200 pt-4 mt-4 space-y-4">
    <div
      class="fixed bottom-24 left-0 right-0 bg-base-100 border-t border-base-300 px-4 py-3 shadow-lg"
    >
      <div class="max-w-3xl mx-auto">
        <div class="flex justify-between font-bold text-base mb-2">
          <span>Total:</span>
          <span>{{ cartService.total() | currency:'ARS' }}</span>
        </div>

        <button
          class="btn btn-primary w-full"
          [disabled]="isSubmitting()"
          (click)="confirmOrder()"
        >
          @if (isSubmitting()) {
          <span class="loading loading-spinner"></span>
          Procesando... } @else { Confirmar pedido }
        </button>
      </div>
    </div>
  </footer>

  }
</section>
