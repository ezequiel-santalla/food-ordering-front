<dialog #dialog class="modal">
  <div class="modal-box max-w-md">
    <h3 class="font-bold text-xl mb-4">Confirmar pago</h3>

    <div class="mb-4">
      <div class="text-xs text-gray-400 uppercase tracking-wide">
        Total a pagar
      </div>
      <div class="mt-1 text-2xl font-semibold">
        {{ totalToPay | currency:'ARS':'symbol-narrow' }}
      </div>
    </div>

    <button
      type="button"
      class="w-full bg-[#009EE3] hover:bg-[#0084BE] text-white border-0 mb-4 rounded-xl flex items-center gap-3 px-3 py-2 transition cursor-pointer disabled:opacity-60"
      (click)="onSelectMercadoPago()"
      [disabled]="isProcessingPayment"
    >
      <div class="flex items-center justify-center w-8 h-8 ml-1">
        @if (!isProcessingPayment) {
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          viewBox="0 0 24 24"
        >
          <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
          <line x1="2" y1="12" x2="22" y2="12"></line>
        </svg>
        } @else {
        <span class="loading loading-spinner loading-sm text-white"></span>
        }
      </div>

      <!-- Texto -->
      <div class="flex flex-col text-left leading-tight flex-1">
        <span class="font-semibold text-[15px]">
          @if (!isProcessingPayment) { Pagar con MercadoPago } @else {
          Redirigiendoâ€¦ }
        </span>

        <span class="text-xs opacity-80 -mt-0.5">
          @if (!isProcessingPayment) { Saldo, tarjetas guardadas o apps } @else
          { Un momento por favor }
        </span>
      </div>
    </button>

    <div class="divider text-xs text-gray-400">o pagar con</div>

    <!-- MÃ‰TODOS PRESENCIALES -->
    <div class="mb-4">
      <div class="text-sm font-medium mb-2">MÃ©todo de pago</div>
      <div class="flex flex-col gap-2">
        @for (m of paymentMethods; track m.value) {
        <label
          class="flex items-center gap-3 rounded-xl border px-3 py-2 cursor-pointer transition hover:border-primary"
          [class.border-primary]="selectedPaymentMethod === m.value"
        >
          <input
            type="radio"
            class="radio radio-primary"
            name="paymentMethod"
            [value]="m.value"
            [checked]="selectedPaymentMethod === m.value"
            (change)="onChangeMethod(m.value)"
          />
          <span class="flex flex-col">
            <span class="text-sm font-medium">{{ m.label }}</span>
          </span>
        </label>
        }
      </div>
    </div>

    <!-- LISTA DE PEDIDOS -->
    <div class="mb-4">
      <details class="collapse collapse-arrow bg-base-200">
        <summary class="collapse-title text-sm">
          Ver pedidos seleccionados ({{ selectedOrders.length }})
        </summary>

        <div class="collapse-content">
          <ul class="space-y-3 text-sm">
            @for (o of selectedOrders; track o.publicId) {
            <li class="border rounded-lg p-3 bg-base-100">
              <div class="font-medium mb-2">Orden {{ o.orderNumber }}</div>
              <ul class="ml-2 space-y-1 text-xs">
                @for (item of o.items; track item.productName) {
                <li>â€¢ {{ item.quantity }} Ã— {{ item.productName }}</li>
                }
              </ul>
            </li>
            }
          </ul>
        </div>
      </details>
    </div>

    <!-- INFO SEGURA -->
    <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
      <div class="flex items-start gap-2">
        <svg
          class="w-4 h-4 text-blue-600 mt-0.5"
          fill="currentColor"
          viewBox="0 0 20 20"
        >
          <path fill-rule="evenodd" d="M18 10a8 8..." />
        </svg>
        <div class="text-xs text-blue-800">
          <p class="font-medium">ðŸ”’ Pago seguro</p>
          <p class="mt-1 opacity-90">
            Procesado por MercadoPago. NO almacenamos datos de tarjetas.
          </p>
        </div>
      </div>
    </div>

    <!-- ACCIONES PARA PAGOS PRESENCIALES -->
    <div class="modal-action">
      <button
        class="btn btn-ghost"
        (click)="onCancel()"
        [disabled]="isProcessingPayment"
      >
        Cancelar
      </button>

      @if (selectedPaymentMethod === PaymentMethod.CASH || selectedPaymentMethod
      === PaymentMethod.CREDIT_CARD || selectedPaymentMethod ===
      PaymentMethod.DEBIT_CARD || selectedPaymentMethod === PaymentMethod.OTHER
      ) {
      <button
        class="btn btn-primary"
        (click)="onConfirm()"
        [class.loading]="isProcessingPayment"
        [disabled]="isProcessingPayment || !selectedOrders.length"
      >
        Solicitar cobro
      </button>
      }
    </div>
  </div>

  <form method="dialog" class="modal-backdrop">
    <button aria-label="Cerrar modal" [disabled]="isProcessingPayment">
      close
    </button>
  </form>
</dialog>
